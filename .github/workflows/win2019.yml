name: Windows 2019 Tailscale RDP

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-2019
    timeout-minutes: 360

    steps:
    - name: Create Scripts Locally
      run: |
        # Create start.bat with custom username Head-node
        @'
        @echo off
        net config server /srvcomment:"Windows Server 2019 Tailscale" > nul
        REG ADD "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" /V EnableAutoTray /T REG_DWORD /D 0 /F > nul
        
        # Creating user Head-node with strong password
        net user Head-node Tailscale@2026! /add >nul
        net localgroup administrators Head-node /add >nul
        
        diskperf -Y >nul
        sc config Audiosrv start= auto >nul
        sc start audiosrv >nul
        echo ---------------------------------------
        echo RDP IS READY
        echo Address:
        tailscale ip -4
        echo Username: Head-node
        echo Password: Tailscale@2026!
        echo ---------------------------------------
        '@ | Out-File -FilePath start.bat -Encoding ASCII

    - name: Setup Tailscale (Latest)
      uses: tailscale/github-action@v3
      with:
        authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
        version: latest

    - name: Enabling access to RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Start RDP Configuration
      run: ./start.bat

    - name: Keep Alive Loop
      run: |
        Write-Host "RDP IS ACTIVE. Connect using the IP above."
        while($true) {
          Start-Sleep -Seconds 60
        }
